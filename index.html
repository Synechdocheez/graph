<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mileage Viewer</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9fb;
      margin: 30px;
      color: #333;
    }

    h1 {
      margin-bottom: 10px;
      font-size: 24px;
    }

    #controls {
      margin-bottom: 20px;
    }

    label, select {
      font-size: 16px;
    }

    svg {
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 8px;
    }

    .line {
      fill: none;
      stroke: #0077cc;
      stroke-width: 2.5px;
    }

    .dot {
      fill: white;
      stroke: #0077cc;
      stroke-width: 2px;
      r: 4;
    }

    .tooltip {
      position: absolute;
      background: #333;
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
      pointer-events: none;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      visibility: hidden;
      transition: 0.15s ease-in-out;
    }
  </style>
</head>
<body>

  <h1>Weekly Mileage Viewer</h1>

  <div id="controls">
    <label for="span">Select time span:</label>
    <select id="span">
      <option value="7">Last 7 days</option>
      <option value="30">Last 30 days</option>
      <option value="90">Last 90 days</option>
      <option value="365">Last 365 days</option>
    </select>
  </div>

  <div style="position: relative;">
    <svg width="900" height="400"></svg>
    <div class="tooltip" id="tooltip"></div>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    function generateDummyData() {
      const data = [];
      const today = new Date();
      for (let i = 0; i < 365; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        data.push({
          date: d,
          miles: +(Math.random() * 10).toFixed(1)
        });
      }
      return data.sort((a,b) => a.date - b.date);
    }

    const rawData = generateDummyData();
    const svg = d3.select("svg");
    const margin = { top: 20, right: 30, bottom: 40, left: 50 };
    const width = +svg.attr("width") - margin.left - margin.right;
    const height = +svg.attr("height") - margin.top - margin.bottom;
    const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    const x = d3.scaleTime().range([0, width]);
    const y = d3.scaleLinear().range([height, 0]);
    const line = d3.line().x(d => x(d.date)).y(d => y(d.miles)).curve(d3.curveMonotoneX);
    const tooltip = d3.select("#tooltip");

    const xAxisG = g.append("g").attr("transform", `translate(0,${height})`);
    const yAxisG = g.append("g");

    const overlay = g.append("rect")
      .attr("width", width)
      .attr("height", height)
      .style("fill", "none")
      .style("pointer-events", "all");

    const focus = g.append("g").style("display", "none");
    const focusDot = focus.append("circle")
      .attr("class", "dot")
      .attr("r", 5);

    const bisectDate = d3.bisector(d => d.date).left;

    function update(spanDays) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - spanDays);
      const data = rawData.filter(d => d.date >= cutoff);

      x.domain(d3.extent(data, d => d.date));
      y.domain([0, d3.max(data, d => d.miles) * 1.1]);

      g.selectAll(".line").data([data])
        .join("path")
        .attr("class", "line")
        .attr("d", line);

      g.selectAll(".dot").data(data)
        .join("circle")
        .attr("class", "dot")
        .attr("cx", d => x(d.date))
        .attr("cy", d => y(d.miles))
        .attr("r", 4);

      xAxisG.call(d3.axisBottom(x).ticks(Math.min(spanDays / 7, 12)).tickFormat(d3.timeFormat("%b %d")));
      yAxisG.call(d3.axisLeft(y));

      overlay.on("mouseover", () => {
          focus.style("display", null);
          tooltip.style("visibility", "visible");
        })
        .on("mouseout", () => {
          focus.style("display", "none");
          tooltip.style("visibility", "hidden");
        })
        .on("mousemove", function(event) {
          const [mx] = d3.pointer(event, this);
          const x0 = x.invert(mx);
          const i = bisectDate(data, x0, 1);
          const d0 = data[i - 1];
          const d1 = data[i] || d0;
          const d = (x0 - d0.date) > (d1.date - x0) ? d1 : d0;

          const cx = x(d.date);
          const cy = y(d.miles);
          focusDot.attr("cx", cx).attr("cy", cy);

          const tooltipHTML = `
            <strong>${d3.timeFormat("%B %d, %Y")(d.date)}</strong><br>
            Miles: <b>${d.miles}</b>
          `;
          tooltip
            .html(tooltipHTML)
            .style("top", (cy + margin.top + 20) + "px")
            .style("left", (cx + margin.left + 10) + "px");
        });
    }

    update(7);
    d3.select("#span").on("change", function() {
      update(+this.value);
    });
  </script>
</body>
</html>
